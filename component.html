<polymer-element name="ceci-pledge" attributes="readonly pledge email server" extends="ceci-element">
  <ceci-definition>
    {
      "tags": ["email", "pledge"],
      "thumbnail": "./thumbnail.png",
      "name": "Pledge",
      "broadcasts": {
        "emailChanged": {
          "label": "Email Changed",
          "description": "Occurs when email address changed."
        },
        "pledgeSubmitted": {
          "label": "Pledge Submitted",
          "description": "Occurs when pledge submission has been successfully completed."
        },
        "pledgeError": {
          "label": "Pledge Error",
          "description": "Occurs when pledge submission failed."
        }
      },
      "listeners": {
        "send": {
          "description": "Sends pledge.",
          "label": "Send Pledge",
          "default": "green"
        },
        "clearPledge": {
          "description": "Clears the pledge data.",
          "label": "Clear Data"
        }
      },
      "attributes": {
        "readonly": {
          "label": "Read-Only",
          "description": "Disables editing pledge and email from UI.",
          "editable": "boolean"
        },
        "pledge": {
          "label": "Pledge",
          "description": "Pledge data to submit.",
          "editable": "text",
          "listener": "true",
          "defaultListener": "orange"
        },
        "email": {
          "label": "Email Address",
          "description": "Recipient's email address",
          "editable": "text",
          "listener": true,
          "defaultListener": "yellow"
        },
        "server": {
          "label": "Mail Server",
          "description": "URL to server to which email will be POSTed.",
          "editable": "text"
        }
      }
    }
  </ceci-definition>
  <template>
    <style>
      :host {
        display: block;
        min-height: 50px;
        width: 100%;
        font-family: sans-serif;
        font-size: 12pt;
        background: white;
        padding: 1em 0;
      }

      :host .input-container {
        margin-top: .5em;
        margin-bottom: .5em;
        margin-left: 1em;
        margin-right: 2em;
      }

      :host input {
        font-family: sans-serif;
        font-size: 1em;
        display: inline-block;
        width: 100%;
      }
    </style>
    <div id="status">{{status}}</div>
    <div class="input-container">
      <div>Email:</div>
      <input type="text" id="email" readonly?="{{readonly == 'true'}}" value="{{email}}" placeholder="me@somewhere.fun"/></div>
    <div class="input-container">
      <div>Pledge:</div>
      <input type="text" readonly?="{{readonly == 'true'}}" value="{{pledge}}" placeholder="One free introspection"></div>
    <shadow></shadow>
  </template>
  <script>
    Polymer('ceci-pledge', {
      readonly: 'false',
      pledge: '',
      server: 'http://component-pledge-server.herokuapp.com/send',
      ready: function () {
        this.super();
        this.status = '';
      },
      send: function () {
        var that = this;

        if (!this.email.trim()) {
          this.status = 'Email is missing!';
          return;
        }
        if (!this.pledge.trim()) {
          this.status = 'Pledge is missing!';
          return;
        }

        var xhr = new XMLHttpRequest();
        xhr.open('POST', this.server, true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.onreadystatechange = function (e) {
          that.status = 'Sending...';
        };
        xhr.onerror = function (e) {
          console.error('error', xhr.statusText, e);
          that.status = 'Error! Try again soon!';
          that.broacast('pledgeError');
        };
        xhr.onload = function (e) {
          that.status = 'Sent!';
          that.broacast('pledgeSubmitted');
        };
        xhr.send('email=' + encodeURIComponent(encodeURIComponent(this.email)) + '&items=' + escape(pledge));
      },
      clearData: function () {
        this.pledge = '';
      }
    });
  </script>
</polymer-element>
